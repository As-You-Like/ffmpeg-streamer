{"version":3,"sources":["../../es6_public/player.es6"],"names":[],"mappings":"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","file":"player.js","sourcesContent":["// jshint browser: true\r\n'use strict'\r\n\r\n/*\r\nlag 2 = threshold for current play time behind available buffer end time to trigger play head move, will split the measured lag difference / 2\r\npast 20 = duration of buffered video past current play time to trigger buffer removal\r\nkeep 5 = duration of buffer to keep past current play time when removing old buffer\r\n- too low of allowable lag will cause unstable playback\r\n- too high of allowable lag may cause realtime latency\r\n- removing too much past buffer can cause unstable playback\r\n- removing too little will increase memory use in browser for storing extra buffer\r\n */\r\nconst config = {lag: 2.0, past: 20, keep: 5}\r\n\r\nclass VideoPlayer {\r\n  constructor (options, callback) {\r\n    if (typeof callback === 'function' && callback.length === 2) {\r\n      this._callback = callback\r\n    } else {\r\n      this._callback = (err, msg) => {\r\n        if (err) {\r\n          console.error(`VideoPlayer Error: ${err} Namespace: ${this._namespace}`)\r\n          return\r\n        }\r\n        console.log(`VideoPlayer Message: ${msg} Namespace: ${this._namespace}`)\r\n      }\r\n    }\r\n    if (!options.video || !(options.video instanceof window.HTMLVideoElement)) {\r\n      this._callback('\"options.video\" is not a video element')\r\n      return\r\n    }\r\n    if (!options.namespace) {\r\n      this._callback('missing \"options.namespace\"')\r\n      return\r\n    }\r\n    if (!options.io || !options.io.hasOwnProperty('Socket')) {\r\n      this._callback('\"options.io is not an instance of socket.io')\r\n      return\r\n    }\r\n    this._video = options.video\r\n    if (options.controls) {\r\n      const stb = options.controls.indexOf('startstop') !== -1\r\n      const fub = options.controls.indexOf('fullscreen') !== -1\r\n      const snb = options.controls.indexOf('snapshot') !== -1\r\n      const cyb = options.controls.indexOf('cycle') !== -1\r\n      // todo: mute and volume buttons will be determined automatically based on codec string\r\n      if (stb || fub || snb || cyb) {\r\n        this._container = document.createElement('div')\r\n        this._container.className = 'mse-container'\r\n        this._video.parentNode.replaceChild(this._container, this._video)\r\n        this._video.className = 'mse-video'\r\n        this._video.controls = false\r\n        this._video.removeAttribute('controls')\r\n        this._container.appendChild(this._video)\r\n        this._controls = document.createElement('div')\r\n        this._controls.className = 'mse-controls'\r\n        this._container.appendChild(this._controls)\r\n        if (stb) {\r\n          this._startstop = document.createElement('button')\r\n          this._startstop.className = 'mse-start'\r\n          this._startstop.addEventListener('click', (/* event */) => {\r\n            this.togglePlay()\r\n          })\r\n          this._controls.appendChild(this._startstop)\r\n        }\r\n        if (fub) {\r\n          this._fullscreen = document.createElement('button')\r\n          this._fullscreen.className = 'mse-fullscreen'\r\n          this._fullscreen.addEventListener('click', (/* event */) => {\r\n            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {\r\n              if (this._container.requestFullscreen) {\r\n                this._container.requestFullscreen()\r\n              } else if (this._container.msRequestFullscreen) {\r\n                this._container.msRequestFullscreen()\r\n              } else if (this._container.mozRequestFullScreen) {\r\n                this._container.mozRequestFullScreen()\r\n              } else if (this._container.webkitRequestFullscreen) {\r\n                this._container.webkitRequestFullscreen(window.Element.ALLOW_KEYBOARD_INPUT)\r\n              }\r\n            } else {\r\n              if (document.exitFullscreen) {\r\n                document.exitFullscreen()\r\n              } else if (document.msExitFullscreen) {\r\n                document.msExitFullscreen()\r\n              } else if (document.mozCancelFullScreen) {\r\n                document.mozCancelFullScreen()\r\n              } else if (document.webkitExitFullscreen) {\r\n                document.webkitExitFullscreen()\r\n              }\r\n            }\r\n          })\r\n          this._controls.appendChild(this._fullscreen)\r\n        }\r\n        if (snb) {\r\n          this._snapshot = document.createElement('button')\r\n          this._snapshot.className = 'mse-snapshot'\r\n          this._snapshot.addEventListener('click', (/* event */) => {\r\n            if (this._video.readyState < 2) {\r\n              this._callback(null, `readyState: ${this._video.readyState} < 2`)\r\n              return\r\n            }\r\n            // safari bug, cannot use video as source for canvas drawImage when it is being used as media source extension (only works when using regular m3u8 playlist)\r\n            // will hide icon until creating a server side response to deliver a snapshot\r\n            const canvas = document.createElement('canvas')\r\n            // this._container.appendChild(canvas);\r\n            canvas.width = this._video.videoWidth\r\n            canvas.height = this._video.videoHeight\r\n            const ctx = canvas.getContext('2d')\r\n            ctx.drawImage(this._video, 0, 0, canvas.width, canvas.height)\r\n            const href = canvas.toDataURL('image/jpeg', 1.0)\r\n            const link = document.createElement('a')\r\n            link.href = href\r\n            const date = new Date().getTime()\r\n            link.download = `${this._namespace}-${date}-snapshot.jpeg`\r\n            // link must be added so that link.click() will work on firefox\r\n            this._container.appendChild(link)\r\n            link.click()\r\n            this._container.removeChild(link)\r\n          })\r\n          this._controls.appendChild(this._snapshot)\r\n        }\r\n        if (cyb) {\r\n          this._cycle = document.createElement('button')\r\n          this._cycle.className = 'mse-cycle'\r\n          this._cycling = false\r\n          if (options.cycleTime) {\r\n            const int = parseInt(options.cycleTime)\r\n            if (int < 2) {\r\n              this._cycleTime = 2000\r\n            } else if (int > 10) {\r\n              this._cycleTime = 10000\r\n            } else {\r\n              this._cycleTime = int * 1000\r\n            }\r\n          } else {\r\n            this._cycleTime = 2000\r\n          }\r\n          this._cycle.addEventListener('click', (/* event */) => {\r\n            if (!this._cycling) {\r\n              this._namespaces = []\r\n              this._cycleIndex = 0\r\n              const videoPlayers = window.videoPlayers\r\n              for (let i = 0; i < videoPlayers.length; i++) {\r\n                this._namespaces.push(videoPlayers[i].namespace)\r\n                if (videoPlayers[i] !== this) {\r\n                  videoPlayers[i].disabled = true\r\n                } else {\r\n                  this._cycleIndex = i\r\n                }\r\n              }\r\n              if (this._namespaces.length < 2) {\r\n                this._callback(null, 'unable to cycle because namespaces < 2')\r\n                delete this._namespaces\r\n                delete this._cycleIndex\r\n                return\r\n              }\r\n              if (!this._playing) {\r\n                this.start()\r\n              }\r\n              if (this._startstop) {\r\n                this._startstop.classList.add('cycling')\r\n              }\r\n              this._cycle.classList.add('animated')\r\n              this._cycleInterval = setInterval(() => {\r\n                this._cycleIndex++\r\n                if (this._cycleIndex === this._namespaces.length) {\r\n                  this._cycleIndex = 0\r\n                }\r\n                this.start(this._namespaces[this._cycleIndex])\r\n              }, this._cycleTime)\r\n              this._cycling = true\r\n            } else {\r\n              clearInterval(this._cycleInterval)\r\n              this._cycle.classList.remove('animated')\r\n              if (this._startstop) {\r\n                this._startstop.classList.remove('cycling')\r\n              }\r\n              this.start()\r\n              const videoPlayers = window.videoPlayers\r\n              for (let i = 0; i < videoPlayers.length; i++) {\r\n                if (videoPlayers[i] !== this) {\r\n                  videoPlayers[i].disabled = false\r\n                }\r\n              }\r\n              delete this._namespaces\r\n              delete this._cycleInterval\r\n              this._cycling = false\r\n            }\r\n          })\r\n          this._controls.appendChild(this._cycle)\r\n        }\r\n      }\r\n    }\r\n    this._namespace = options.namespace\r\n    this._io = options.io\r\n    if (!window.videoPlayers) {\r\n      window.videoPlayers = []\r\n    }\r\n    window.videoPlayers.push(this)\r\n    return this\r\n  }\r\n\r\n  get namespace () {\r\n    return this._namespace || null\r\n  }\r\n\r\n  set namespace (value) {\r\n    this._namespace = value\r\n  }\r\n\r\n  /** @return {boolean} */\r\n  get disabled () {\r\n    if (!this._container) {\r\n      return false\r\n    }\r\n    return this._container.classList.contains('disabled')\r\n  }\r\n\r\n  /** @param {boolean} bool */\r\n  set disabled (bool) {\r\n    if (!this._container) {\r\n      return\r\n    }\r\n    if (bool === true) {\r\n      if (this._container.classList.contains('disabled')) {\r\n        return\r\n      }\r\n      this._container.classList.add('disabled')\r\n      this.stop()\r\n    } else {\r\n      if (!this._container.classList.contains('disabled')) {\r\n        return\r\n      }\r\n      this._container.classList.remove('disabled')\r\n      this.start()\r\n    }\r\n  }\r\n\r\n  /* ----------------------- public methods ----------------------- */\r\n\r\n  mediaInfo () {\r\n    let str = `******************\\n`\r\n    str += `namespace : ${this._namespace}\\n`\r\n    if (this._video) {\r\n      str += `video.paused : ${this._video.paused}\\nvideo.currentTime : ${this._video.currentTime}\\nvideo.src : ${this._video.src}\\n`\r\n      if (this._sourceBuffer.buffered.length) {\r\n        str += `buffered.length : ${this._sourceBuffer.buffered.length}\\nbuffered.end(0) : ${this._sourceBuffer.buffered.end(0)}\\nbuffered.start(0) : ${this._sourceBuffer.buffered.start(0)}\\nbuffered size : ${this._sourceBuffer.buffered.end(0) - this._sourceBuffer.buffered.start(0)}\\nlag : ${this._sourceBuffer.buffered.end(0) - this._video.currentTime}\\n`\r\n      }\r\n    }\r\n    str += `******************\\n`\r\n    console.info(str)\r\n  }\r\n\r\n  togglePlay () {\r\n    if (this._playing === true) {\r\n      this.stop()\r\n    } else {\r\n      this.start()\r\n    }\r\n    return this\r\n  }\r\n\r\n  start (namespace) {\r\n    if (!namespace) {\r\n      namespace = this._namespace\r\n    }\r\n    // todo maybe pass namespace as parameter to start(namespace) to accommodate cycling feature\r\n    if (this._playing === true) {\r\n      this.stop()\r\n    }\r\n    if (this._startstop) {\r\n      this._startstop.classList.add('mse-stop')\r\n      this._startstop.classList.remove('mse-start')\r\n      this._startstop.disabled = true\r\n    }\r\n    this._playing = true\r\n    this._socket = this._io(`${window.location.origin}/${namespace}`, {transports: ['websocket'], forceNew: false})\r\n    this._addSocketEvents()\r\n    if (this._startstop) {\r\n      this._startstop.disabled = false\r\n    }\r\n    return this\r\n  }\r\n\r\n  stop () {\r\n    if (this._startstop) {\r\n      this._startstop.classList.add('mse-start')\r\n      this._startstop.classList.remove('mse-stop')\r\n      this._startstop.disabled = true\r\n    }\r\n    this._playing = false\r\n    if (this._video) {\r\n      this._removeVideoEvents()\r\n      this._video.pause()\r\n      this._video.removeAttribute('src')\r\n      // this._video.src = '';//todo: not sure if NOT removing this will cause memory leak\r\n      this._video.load()\r\n    }\r\n    if (this._socket) {\r\n      this._removeSocketEvents()\r\n      if (this._socket.connected) {\r\n        this._socket.disconnect()\r\n      }\r\n      delete this._socket\r\n    }\r\n    if (this._mediaSource) {\r\n      this._removeMediaSourceEvents()\r\n      if (this._mediaSource.sourceBuffers && this._mediaSource.sourceBuffers.length) {\r\n        this._mediaSource.removeSourceBuffer(this._sourceBuffer)\r\n      }\r\n      delete this._mediaSource\r\n    }\r\n    if (this._sourceBuffer) {\r\n      this._removeSourceBufferEvents()\r\n      if (this._sourceBuffer.updating) {\r\n        this._sourceBuffer.abort()\r\n      }\r\n      delete this._sourceBuffer\r\n    }\r\n    if (this._startstop) {\r\n      this._startstop.disabled = false\r\n    }\r\n    return this\r\n  }\r\n\r\n  destroy () {\r\n    // todo: possibly strip control buttons and other layers added around video player\r\n    return this\r\n  }\r\n\r\n  /* ----------------------- video element events ----------------------- */\r\n\r\n  _onVideoError (event) {\r\n    this._callback(`video error ${event.type}`)\r\n  }\r\n\r\n  _onVideoLoadedData (event) {\r\n    this._callback(null, `video loaded data ${event.type}`)\r\n    if ('Promise' in window) {\r\n      this._video.play()\r\n        .then(() => {\r\n          // this._callback(null, 'play promise fulfilled');\r\n          // todo remove \"click to play\" poster\r\n        })\r\n        .catch((error) => {\r\n          this._callback(error)\r\n          // todo add \"click to play\" poster\r\n        })\r\n    } else {\r\n      this._video.play()\r\n    }\r\n  }\r\n\r\n  _addVideoEvents () {\r\n    if (!this._video) {\r\n      return\r\n    }\r\n    this.onVideoError = this._onVideoError.bind(this)\r\n    this._video.addEventListener('error', this.onVideoError, {capture: true, passive: true, once: true})\r\n    this.onVideoLoadedData = this._onVideoLoadedData.bind(this)\r\n    this._video.addEventListener('loadeddata', this.onVideoLoadedData, {capture: true, passive: true, once: true})\r\n    this._callback(null, 'added video events')\r\n  }\r\n\r\n  _removeVideoEvents () {\r\n    if (!this._video) {\r\n      return\r\n    }\r\n    this._video.removeEventListener('error', this.onVideoError, {capture: true, passive: true, once: true})\r\n    delete this.onVideoError\r\n    this._video.removeEventListener('loadeddata', this.onVideoLoadedData, {capture: true, passive: true, once: true})\r\n    delete this.onVideoLoadedData\r\n    this._callback(null, 'removed video events')\r\n  }\r\n\r\n  /* ----------------------- media source events ----------------------- */\r\n\r\n  _onMediaSourceClose (event) {\r\n    this._callback(null, `media source close ${event.type}`)\r\n  }\r\n\r\n  _onMediaSourceOpen (/* event */) {\r\n    window.URL.revokeObjectURL(this._video.src)\r\n    this._mediaSource.duration = Number.POSITIVE_INFINITY\r\n    this._sourceBuffer = this._mediaSource.addSourceBuffer(this._mime)\r\n    this._sourceBuffer.mode = 'sequence'// chrome was complaining about timestamps when set to sequence\r\n    // this._sourceBuffer.mode = 'segments';\r\n    this._addSourceBufferEvents()\r\n    this._sourceBuffer.appendBuffer(this._init)\r\n    // this._video.setAttribute('poster', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxyZWN0IHg9Ii0xIiB5PSItMSIgd2lkdGg9IjY0MiIgaGVpZ2h0PSIzNiIgZmlsbD0ibm9uZSIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAiIHg9IjE2MCIgeT0iMjYiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iIzAwMCI+cmVxdWVzdGluZyBtZWRpYSBzZWdtZW50czwvdGV4dD48L2c+PC9zdmc+');\r\n    this.onSegment = this._onSegment.bind(this)\r\n    this._socket.addEventListener('segment', this.onSegment, {capture: true, passive: true, once: false})\r\n    this._socket.send('segments')\r\n    // this._video.muted = true;\r\n  }\r\n\r\n  _addMediaSourceEvents () {\r\n    if (!this._mediaSource) {\r\n      return\r\n    }\r\n    this.onMediaSourceClose = this._onMediaSourceClose.bind(this)\r\n    this._mediaSource.addEventListener('sourceclose', this.onMediaSourceClose, {capture: true, passive: true, once: true})\r\n    this.onMediaSourceOpen = this._onMediaSourceOpen.bind(this)\r\n    this._mediaSource.addEventListener('sourceopen', this.onMediaSourceOpen, {capture: true, passive: true, once: true})\r\n  }\r\n\r\n  _removeMediaSourceEvents () {\r\n    if (!this._mediaSource) {\r\n      return\r\n    }\r\n    this._mediaSource.removeEventListener('sourceclose', this.onMediaSourceClose, {capture: true, passive: true, once: true})\r\n    delete this.onMediaSourceClose\r\n    this._mediaSource.removeEventListener('sourceopen', this.onMediaSourceOpen, {capture: true, passive: true, once: true})\r\n    delete this.onMediaSourceOpen\r\n  }\r\n\r\n  /* ----------------------- source buffer events ----------------------- */\r\n\r\n  _onSourceBufferError (event) {\r\n    this._callback(`sourceBufferError ${event.type}`)\r\n  }\r\n\r\n  _onSourceBufferUpdateEnd (/* event */) {\r\n    // cant do anything to sourceBuffer if it is updating\r\n    if (this._sourceBuffer.updating) {\r\n      return\r\n    }\r\n    // if has last segment pending, append it\r\n    if (this._lastSegment) {\r\n      // this._callback(null, 'using this._lastSegment');\r\n      this._sourceBuffer.appendBuffer(this._lastSegment)\r\n      delete this._lastSegment\r\n      return\r\n    }\r\n    // check if buffered media exists\r\n    if (!this._sourceBuffer.buffered.length) {\r\n      return\r\n    }\r\n    // current time of play position\r\n    const currentTime = this._video.currentTime\r\n    // start time for currently buffered video\r\n    const start = this._sourceBuffer.buffered.start(0)\r\n    // end time for currently buffered video\r\n    const end = this._sourceBuffer.buffered.end(0)\r\n    // duration of currently buffered video behind current play time\r\n    const past = currentTime - start\r\n    // todo play with numbers and make dynamic or user configurable\r\n    if (past > config.past && currentTime < end) {\r\n      this._sourceBuffer.remove(start, currentTime - config.keep)// was 4\r\n    }\r\n  }\r\n\r\n  _addSourceBufferEvents () {\r\n    if (!this._sourceBuffer) {\r\n      return\r\n    }\r\n    this.onSourceBufferError = this._onSourceBufferError.bind(this)\r\n    this._sourceBuffer.addEventListener('error', this.onSourceBufferError, {capture: true, passive: true, once: true})\r\n    this.onSourceBufferUpdateEnd = this._onSourceBufferUpdateEnd.bind(this)\r\n    this._sourceBuffer.addEventListener('updateend', this.onSourceBufferUpdateEnd, {capture: true, passive: true, once: false})\r\n  }\r\n\r\n  _removeSourceBufferEvents () {\r\n    if (!this._sourceBuffer) {\r\n      return\r\n    }\r\n    this._sourceBuffer.removeEventListener('error', this.onSourceBufferError, {capture: true, passive: true, once: true})\r\n    delete this.onSourceBufferError\r\n    this._sourceBuffer.removeEventListener('updateend', this.onSourceBufferUpdateEnd, {capture: true, passive: true, once: false})\r\n    delete this.onSourceBufferUpdateEnd\r\n  }\r\n\r\n  /* ----------------------- socket.io events ----------------------- */\r\n\r\n  _onSocketConnect (/* event */) {\r\n    // this._callback(null, 'socket connect');\r\n    // this._video.setAttribute('poster', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxyZWN0IHg9Ii0xIiB5PSItMSIgd2lkdGg9IjY0MiIgaGVpZ2h0PSIzNiIgZmlsbD0ibm9uZSIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAiIHg9IjE5NiIgeT0iMjYiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iIzAwMCI+cmVxdWVzdGluZyBtaW1lIHR5cGU8L3RleHQ+PC9nPjwvc3ZnPg==');\r\n    this.onMime = this._onMime.bind(this)\r\n    this._socket.addEventListener('mime', this.onMime, {capture: true, passive: true, once: true})\r\n    this._socket.send('mime')\r\n  }\r\n\r\n  _onSocketDisconnect (event) {\r\n    this._callback(null, `socket disconnect \"${event}\"`)\r\n    this.stop()\r\n  }\r\n\r\n  _onSocketError (event) {\r\n    this._callback(`socket error \"${event}\"`)\r\n    this.stop()\r\n  }\r\n\r\n  _onMime (data) {\r\n    this._mime = data\r\n    if (!window.MediaSource.isTypeSupported(this._mime)) {\r\n      this._video.setAttribute('poster', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxyZWN0IHg9Ii0xIiB5PSItMSIgd2lkdGg9IjY0MiIgaGVpZ2h0PSIzNiIgZmlsbD0ibm9uZSIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAiIHg9IjE3NyIgeT0iMjYiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iIzAwMCI+bWltZSB0eXBlIG5vdCBzdXBwb3J0ZWQ8L3RleHQ+PC9nPjwvc3ZnPg==')\r\n      this._callback(`unsupported mime \"${this._mime}\"`)\r\n      return\r\n    }\r\n    // this._video.setAttribute('poster', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxyZWN0IHg9Ii0xIiB5PSItMSIgd2lkdGg9IjY0MiIgaGVpZ2h0PSIzNiIgZmlsbD0ibm9uZSIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAiIHg9IjE4NiIgeT0iMjYiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iIzAwMCI+cmVxdWVzdGluZyBpbml0IHNlZ21lbnQ8L3RleHQ+PC9nPjwvc3ZnPg==');\r\n    this.onInit = this._onInit.bind(this)\r\n    this._socket.addEventListener('initialization', this.onInit, {capture: true, passive: true, once: true})\r\n    this._socket.send('initialization')\r\n  }\r\n\r\n  _onInit (data) {\r\n    this._init = data\r\n    this._mediaSource = new window.MediaSource()\r\n    this._addMediaSourceEvents()\r\n    this._addVideoEvents()\r\n    this._video.src = window.URL.createObjectURL(this._mediaSource)\r\n  }\r\n\r\n  _onSegment (data) {\r\n    if (this._sourceBuffer.buffered.length) {\r\n      const lag = this._sourceBuffer.buffered.end(0) - this._video.currentTime\r\n      if (lag > config.lag) { // was 0.5\r\n        // move play head\r\n        this._video.currentTime = this._sourceBuffer.buffered.end(0) - lag / 2// split the difference between buffer end time and current play time\r\n      }\r\n    }\r\n    if (this._sourceBuffer.updating) {\r\n      this._lastSegment = data\r\n    } else {\r\n      delete this._lastSegment\r\n      this._sourceBuffer.appendBuffer(data)\r\n    }\r\n  }\r\n\r\n  _addSocketEvents () {\r\n    if (!this._socket) {\r\n      return\r\n    }\r\n    this.onSocketConnect = this._onSocketConnect.bind(this)\r\n    this._socket.addEventListener('connect', this.onSocketConnect, {capture: true, passive: true, once: true})\r\n    this.onSocketDisconnect = this._onSocketDisconnect.bind(this)\r\n    this._socket.addEventListener('disconnect', this.onSocketDisconnect, {capture: true, passive: true, once: true})\r\n    this.onSocketError = this._onSocketError.bind(this)\r\n    this._socket.addEventListener('error', this.onSocketError, {capture: true, passive: true, once: true})\r\n  }\r\n\r\n  _removeSocketEvents () {\r\n    if (!this._socket) {\r\n      return\r\n    }\r\n    this._socket.removeEventListener('connect', this.onSocketConnect, {capture: true, passive: true, once: true})\r\n    delete this.onSocketConnect\r\n    this._socket.removeEventListener('disconnect', this.onSocketDisconnect, {capture: true, passive: true, once: true})\r\n    delete this.onSocketDisconnect\r\n    this._socket.removeEventListener('error', this.onSocketError, {capture: true, passive: true, once: true})\r\n    delete this.onSocketError\r\n    this._socket.removeEventListener('mime', this.onMime, {capture: true, passive: true, once: true})\r\n    delete this.onMime\r\n    this._socket.removeEventListener('initialization', this.onInit, {capture: true, passive: true, once: true})\r\n    delete this.onInit\r\n    this._socket.removeEventListener('segment', this.onSegment, {capture: true, passive: true, once: false})\r\n    delete this.onSegment\r\n  }\r\n}\r\n\r\n(function mse (window) {\r\n  if (!('io' in window)) {\r\n    throw new Error('socket.io was not found')\r\n    // return;\r\n  }\r\n\r\n  // get all video elements on page\r\n  const videos = document.getElementsByTagName('video')\r\n\r\n  // array to keep reference to newly created VideoPlayers, maybe could be a keyed object\r\n  // const videoPlayers = [];\r\n\r\n  for (let i = 0; i < videos.length; i++) {\r\n    const video = videos[i]\r\n    // only grab video elements that deliberately have data-namespace attribute\r\n    if (video.dataset.namespace) {\r\n      const videoPlayer = new VideoPlayer({video: video, io: window.io, namespace: video.dataset.namespace, controls: video.dataset.controls})\r\n      if (video.autoplay) {\r\n        videoPlayer.start()\r\n      }\r\n      // videoPlayers.push(videoPlayer);\r\n    }\r\n  }\r\n\r\n  // make videoPlayers accessible\r\n  // window.videoPlayers = videoPlayers;\r\n})(window)\r\n\r\n// todo steps for creation of video player\r\n// script is loaded at footer so that it can run after html is ready on page\r\n// verify that socket.io is defined in window\r\n// iterate each video element that has custom data-namespace attributes that we need\r\n// initiate socket to get information from server\r\n// first request codec string to test against browser and then feed first into source\r\n// then request init-segment to feed\r\n// then request media segments until we run into pause, stop, close, error, buffer not ready, etc\r\n// change poster on video element based on current status, error, not ready, etc\r\n"]}